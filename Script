local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local Workspace = game:GetService("Workspace")

-- BRAINROT DATA (PRICE + GENERATION)
local allBrainrots = require(game:GetService("ReplicatedStorage").Datas.Animals)

-- 3 WEBHOOKS BASED ON GENERATION
local WEBHOOKS = {
    {url = "https://discord.com/api/webhooks/1444263728446050455/iYXA8aaJOfWhlgCQ04YwW3vzraBAwIEvDi7-EdVgU--ACEXHktcwN69XuEarlVwD6ZR-", min = 1e6, max = 1e7, ping = false},       -- 1M - 10M
    {url = "https://discord.com/api/webhooks/1444263853624918046/u2aeooCDow7VJnJ7kt8oGmylzWIIIIirbnse0VKs1EU_PZPiPUvW8duKk33Qh88xAIiU", min = 1e7, max = 1e8, ping = false},       -- 10M - 100M
    {url = "https://discord.com/api/webhooks/1444263961573724180/8m_9-VsRfxaRU_D7LmUqIM4iVEKP_QlGSdvW1RiC4juu6tkfipBiC3Q-QSQnm4N4XU5_", min = 1e8, max = 1e12, ping = true}      -- 100M+
}

-- Get the correct webhook based on MPS
local function getWebhook(mps)
    for _, wb in ipairs(WEBHOOKS) do
        if mps >= wb.min and mps < wb.max then
            return wb.url, wb.ping
        end
    end
    return nil, false
end

-- Number formatting
local function formatNumber(num)
    local formatted = tostring(math.floor(num))
    while true do
        formatted, k = string.gsub(formatted, "^(-?%d+)(%d%d%d)", "%1,%2")
        if k == 0 then break end
    end
    return formatted
end

-- Scan plots and calculate real generation
local function scanPlot(plot)
    local output = {}
    local best = {MPS = 0, Name = "N/A"}

    for _, obj in ipairs(plot:GetDescendants()) do
        if obj.Name == "AnimalOverhead" then
            local displayName = obj:FindFirstChild("DisplayName") and obj.DisplayName.Text or "Unknown"
            local generation = obj:FindFirstChild("Generation") and tonumber(obj.Generation.Text:gsub("[^%d.]", "")) or 0

            if generation >= 1e6 then
                table.insert(output, string.format("%s = Generation %s", displayName, formatNumber(generation)))
            end

            if generation > best.MPS then
                best.MPS = generation
                best.Name = displayName
            end
        end
    end

    return output, best
end

-- Send webhook
local function sendWebhook(url, ping, embed)
    local payload = HttpService:JSONEncode(ping and {content = "@everyone", embeds = {embed}} or {embeds = {embed}})

    local requestFunction = nil

    -- Check different HTTP request functions depending on executor
    if syn and syn.request then
        requestFunction = syn.request
    elseif http_request then
        requestFunction = http_request
    elseif fluxus and fluxus.request then
        requestFunction = fluxus.request
    elseif request then
        requestFunction = request
    end

    if requestFunction then
        local success, err = pcall(function()
            requestFunction({
                Url = url,
                Method = "POST",
                Headers = {["Content-Type"] = "application/json"},
                Body = payload
            })
        end)
        if not success then
            warn("Webhook failed: ", err)
        end
    else
        warn("No valid HTTP request function found!")
    end
end

-- Server hopping
local function serverHop()
    local url = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
    local success, response = pcall(function()
        return HttpService:JSONDecode(game:HttpGet(url))
    end)
    if success and response and response.data then
        for _, s in ipairs(response.data) do
            if s.playing < s.maxPlayers and s.id ~= game.JobId then
                TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id, Players.LocalPlayer)
                break
            end
        end
    end
end

-- MAIN LOOP
while true do
    local plots = Workspace:FindFirstChild("Plots")
    if plots then
        for _, plot in ipairs(plots:GetChildren()) do
            local lines, best = scanPlot(plot)
            if #lines > 0 then
                local playersCount = #Players:GetPlayers()
                local maxPlayers = 8  -- Steal a Brainrot max players
                local playerName = Players.LocalPlayer.Name

                local webhookURL, pingEveryone = getWebhook(best.MPS)
                if webhookURL then
                    local embed = {
                        title = string.format("1x %s ($%s)", best.Name or "Unknown", formatNumber(best.MPS)),
                        color = 0x5865F2,
                        fields = {
                            {name = "ðŸ§± Brainrots in Base", value = "```\n" .. table.concat(lines, "\n") .. "\n```"},
                            {name = "ðŸ†” Server ID", value = "```".. tostring(game.JobId) .. "```"},
                            {name = "ðŸ“œ Join Script", value = string.format("```lua\ngame:GetService(\"TeleportService\"):TeleportToPlaceInstance(%d, \"%s\", game.Players.LocalPlayer)\n```", game.PlaceId, game.JobId)},
                            {name = "ðŸ¤– Bot", value = "```" .. playerName .. "```"},
                            {name = "ðŸ‘¥ Players", value = "```" .. tostring(playersCount) .. "/" .. tostring(maxPlayers) .. "```"}
                        },
                        footer = {text = os.date("%Y-%m-%d %H:%M")},
                        timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
                    }

                    sendWebhook(webhookURL, pingEveryone, embed)
                end
            end
        end
    end

    task.wait(5)  -- Wait before hopping
    serverHop()   -- Hop to another server
end
