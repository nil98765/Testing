-- Brainrot MPS Hopper / Webhook Notifier
-- GLOBAL_BEST tracks the best money-per-second (MPS) seen.
-- Safe against nils and malformed Generation/DisplayName objects.
-- Set DEBUG = true to see diagnostic prints in the Output.

task.spawn(function()
    local DEBUG = false       -- set true while debugging
    local GLOBAL_BEST = 0     -- explicitly stores best MPS (number)

    local HttpService = game:GetService("HttpService")
    local Players = game:GetService("Players")
    local Workspace = game:GetService("Workspace")
    local TeleportService = game:GetService("TeleportService")

    local Player = Players.LocalPlayer

    -- PASTE YOUR FULL WEBHOOKS HERE
    local WEBHOOK_1M_10M = "https://discord.com/api/webhooks/1444263728446050455/iYXA8aaJOfWhlgCQ04YwW3vzraBAwIEvDi7-EdVgU--ACEXHktcwN69XuEarlVwD6ZR-"
    local WEBHOOK_10M_100M = "https://discord.com/api/webhooks/1444263853624918046/u2aeooCDow7VJnJ7kt8oGmylzWIIIIirbnse0VKs1EU_PZPiPUvW8duKk33Qh88xAIiU"
    local WEBHOOK_100M_INF = "https://discord.com/api/webhooks/1444263961573724180/8m_9-VsRfxaRU_D7LmUqIM4iVEKP_QlGSdvW1RiC4juu6tkfipBiC3Q-QSQnm4N4XU5_"

    -- Universal HTTP Sender (works on many executors)
    local function sendRequest(url, payload)
        local encoded = HttpService:JSONEncode(payload)
        local req = (syn and syn.request) or http_request or (http and http.request) or request
        if not req then
            warn("âŒ Your executor does not support HTTP requests!")
            return false
        end

        local ok, res = pcall(function()
            return req({Url = url, Method = "POST", Headers = {["Content-Type"] = "application/json"}, Body = encoded})
        end)
        if not ok then
            ok, res = pcall(function()
                return req({url = url, method = "POST", headers = {["content-type"] = "application/json"}, body = encoded})
            end)
        end

        if DEBUG then
            if ok then
                print("âœ” Webhook request succeeded:", (type(res) == "table" and (res.StatusCode or res.status) or tostring(res)))
            else
                warn("âŒ Webhook request failed:", res)
            end
        end

        return ok
    end

    -- Robust parser: accepts "$1.2M", "1,200", "âˆž", "1.5k", etc.
    local function parseGen(text)
        if not text then return 0 end
        local s = tostring(text)
        if s == "âˆž" or s == "inf" or s == "âˆž/s" then return math.huge end

        -- normalize: remove currency symbols and whitespace
        s = s:gsub("%s+", "")
        s = s:gsub("%$", "")
        s = s:gsub(",", "")
        s = s:upper()

        -- capture numeric portion (allow negative sign and decimal)
        local numStr = s:match("[%-%d%.]+") or "0"
        local n = tonumber(numStr) or 0

        if s:find("M") then
            n = n * 1e6
        elseif s:find("K") then
            n = n * 1e3
        end

        if n ~= n then -- NaN guard
            return 0
        end
        return n
    end

    local function safeTextValue(obj)
        if not obj then return nil end
        if type(obj.Text) == "string" and obj.Text ~= "" then return obj.Text end
        if obj.Value ~= nil then return tostring(obj.Value) end
        -- some objects use .Label or .Value.Value etc; try tostring as last resort
        local ok, t = pcall(function() return tostring(obj) end)
        return (ok and t) or nil
    end

    local function getPlotBrainrots(plot)
        local list = {}
        for _, obj in ipairs(plot:GetDescendants()) do
            if obj and obj.Name == "AnimalOverhead" then
                local dn = obj:FindFirstChild("DisplayName")
                local gn = obj:FindFirstChild("Generation")

                local nameText = safeTextValue(dn) or "Unknown"
                local genText  = safeTextValue(gn)  or "0"

                local num = parseGen(genText) or 0
                -- ensure numeric and finite
                if type(num) ~= "number" or num ~= num then num = 0 end

                table.insert(list, {
                    Name = nameText,
                    MPS = tostring(genText),
                    NumMPS = num
                })
            end
        end

        -- sort descending by NumMPS (treat missing as 0)
        table.sort(list, function(a, b)
            local an = tonumber((a and a.NumMPS) or 0) or 0
            local bn = tonumber((b and b.NumMPS) or 0) or 0
            return an > bn
        end)

        if DEBUG then
            for i, v in ipairs(list) do
                print(("DEBUG getPlotBrainrots: rank=%d name=%s NumMPS=%s"):format(i, tostring(v.Name), tostring(v.NumMPS)))
            end
        end

        return list
    end

    local function getBestInServer()
        local best, bestPlot
        local plots = Workspace:FindFirstChild("Plots")
        if not plots then
            if DEBUG then warn("No 'Plots' folder in Workspace") end
            return nil, nil
        end

        for _, plot in ipairs(plots:GetChildren()) do
            if not plot then continue end
            local list = getPlotBrainrots(plot)
            if #list > 0 then
                local candidate = list[1]
                local candNum = tonumber((candidate and candidate.NumMPS) or 0) or 0
                local bestNum = tonumber((best and best.NumMPS) or 0) or 0
                if DEBUG then
                    print(("DEBUG evaluating plot=%s candidateNum=%s currentBest=%s"):format(tostring(plot.Name), tostring(candNum), tostring(bestNum)))
                end
                if (not best) or (candNum > bestNum) then
                    best = candidate
                    bestPlot = plot
                end
            end
        end
        return best, bestPlot
    end

    while task.wait(4) do
        local best, plot = getBestInServer()
        local bestNum = tonumber((best and best.NumMPS) or 0) or 0

        if DEBUG then
            print(("Iteration: bestName=%s bestNum=%s GLOBAL_BEST=%s"):format(tostring((best and best.Name) or "nil"), tostring(bestNum), tostring(GLOBAL_BEST)))
        end

        -- Compare MPS values (NumMPS) only
        if best and bestNum > GLOBAL_BEST then
            GLOBAL_BEST = bestNum

            local list = getPlotBrainrots(plot)
            local lines = {}
            for i, b in ipairs(list) do
                local emoji = (i == 1 and "ðŸ‘‘") or (i == 2 and "ðŸ¥ˆ") or (i == 3 and "ðŸ¥‰") or "ðŸ’Ž"
                table.insert(lines, emoji .. " " .. (b.Name or "Unknown") .. " â€” $" .. (b.MPS or "0"))
                if i >= 10 then break end
            end

            -- tier selection based on MPS (NumMPS)
            local url = WEBHOOK_1M_10M
            local ping = false
            if bestNum >= 1e8 then
                url = WEBHOOK_100M_INF
                ping = true
            elseif bestNum >= 1e7 then
                url = WEBHOOK_10M_100M
            end

            local playerName = (Player and Player.Name) and Player.Name or "Unknown"
            local playersCount = #Players:GetPlayers()
            local maxPlayers = Players.MaxPlayers or "N/A"

            local embed = {
                title = string.format("1x %s ($%s)", best.Name or "Unknown", best.MPS or "0"),
                color = 0x5865F2,
                fields = {
                    {name = "ðŸ§± Brainrots in Base", value = "```\n" .. table.concat(lines, "\n") .. "\n```"},
                    {name = "ðŸ†” Server ID", value = "```" .. tostring(game.JobId or "Unknown") .. "```"},
                    {name = "ðŸ“œ Join Script", value = string.format("```lua\ngame:GetService(\"TeleportService\"):TeleportToPlaceInstance(%d, \"%s\", game.Players.LocalPlayer)\n```", tonumber(game.PlaceId) or 0, tostring(game.JobId or ""))},
                    {name = "ðŸ¤– Bot", value = "```" .. playerName .. "```"},
                    {name = "ðŸ‘¥ Players", value = "```" .. tostring(playersCount) .. "/" .. tostring(maxPlayers) .. "```"}
                },
                footer = {text = os.date("%Y-%m-%d %H:%M")},
                timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
            }

            sendRequest(url, ping and {content = "@everyone", embeds = {embed}} or {embeds = {embed}})
            task.wait(2)

            -- attempt to hop to another server (wrapped in pcall)
            pcall(function()
                -- Teleport to same place (will find a new server). This is simpler than trying to TeleportToPlaceInstance
                TeleportService:Teleport(game.PlaceId)
            end)
        else
            if DEBUG then
                if not best then
                    warn("No best found this iteration.")
                else
                    warn(("bestNum (%s) <= GLOBAL_BEST (%s) â€” hopping"):format(tostring(bestNum), tostring(GLOBAL_BEST)))
                end
            end
            task.wait(2)
            pcall(function() TeleportService:Teleport(game.PlaceId) end)
        end
    end
end)
