-- Delta Executor Compatible Brainrot Scanner + Webhook Sender

local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local allBrainrots = require(ReplicatedStorage:WaitForChild("Datas"):WaitForChild("Animals"))

-- Discord Webhook Config
local WEBHOOKS = {
    {url = "https://discord.com/api/webhooks/1444327890706763808/jliKEy3NyFZpESf0aUmowuwzly5jYqJlEJQwdMFJhJq4gDMQFRkuHQINUqZcJeHZ_MVe", min = 1e6, max = 1e7, ping = false},
    {url = "https://discord.com/api/webhooks/1444327890706763808/jliKEy3NyFZpESf0aUmowuwzly5jYqJlEJQwdMFJhJq4gDMQFRkuHQINUqZcJeHZ_MVe", min = 1e7, max = 1e8, ping = false},
    {url = "https://discord.com/api/webhooks/1444327890706763808/jliKEy3NyFZpESf0aUmowuwzly5jYqJlEJQwdMFJhJq4gDMQFRkuHQINUqZcJeHZ_MVe", min = 1e8, max = 1e12, ping = true}
}

local sentServers = {}

-- Delta-compatible HTTP request
local function sendHttpRequest(url, body)
    local requestFunction = http_request or (syn and syn.request)
    if not requestFunction then
        warn("No HTTP request function available! Delta requires HTTP enabled.")
        return
    end
    local success, err = pcall(function()
        requestFunction({
            Url = url,
            Method = "POST",
            Headers = {["Content-Type"] = "application/json"},
            Body = body
        })
    end)
    if not success then
        warn("Webhook failed:", err)
    end
end

-- Format large numbers with commas
local function formatNumber(num)
    local formatted = tostring(math.floor(num))
    while true do
        local k
        formatted, k = string.gsub(formatted, "^(-?%d+)(%d%d%d)", "%1,%2")
        if k == 0 then break end
    end
    return formatted
end

-- Select webhook based on MPS
local function getWebhook(mps)
    for _, wb in ipairs(WEBHOOKS) do
        if mps >= wb.min and mps < wb.max then
            return wb.url, wb.ping
        end
    end
    return nil, false
end

-- Scan a plot for Brainrots
local function scanPlot(plot)
    local output = {}
    local best = {MPS = 0, Name = "N/A"}

    for _, obj in ipairs(plot:GetDescendants()) do
        if obj.Name == "AnimalOverhead" then
            local displayName = obj:FindFirstChild("DisplayName") and obj.DisplayName.Text or "Unknown"
            local generation = obj:FindFirstChild("Generation") and tonumber(obj.Generation.Text:gsub("[^%d.]", "")) or 0

            if generation >= 1e6 then
                table.insert(output, string.format("%s = Generation %s", displayName, formatNumber(generation)))
            end

            if generation > best.MPS then
                best.MPS = generation
                best.Name = displayName
            end
        end
    end

    return output, best
end

-- Send Discord Webhook
local function sendWebhook(url, ping, embed)
    local payload = HttpService:JSONEncode(ping and {content = "@everyone", embeds = {embed}} or {embeds = {embed}})
    sendHttpRequest(url, payload)
end

-- Server Hop
local function serverHop()
    local url = "https://games.roblox.com/v1/games/" .. game.PlaceId .. "/servers/Public?sortOrder=Asc&limit=100"
    local success, response = pcall(function()
        return HttpService:JSONDecode(HttpService:GetAsync(url))
    end)

    if success and response and response.data then
        for _, s in ipairs(response.data) do
            if s.playing < s.maxPlayers and s.id ~= game.JobId then
                print("Hopping to server:", s.id)
                TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id, Players.LocalPlayer)
                return
            end
        end
    end
end

-- MAIN LOOP
task.spawn(function()
    while true do
        local plots = Workspace:FindFirstChild("Plots")
        if plots and not sentServers[game.JobId] then
            local allLines = {}
            local bestOverall = {MPS = 0, Name = "N/A"}

            for _, plot in ipairs(plots:GetChildren()) do
                if plot:IsA("Model") then
                    local lines, best = scanPlot(plot)
                    for _, l in ipairs(lines) do
                        table.insert(allLines, l)
                    end
                    if best.MPS > bestOverall.MPS then
                        bestOverall = best
                    end
                end
            end

            if #allLines > 0 then
                local playersCount = #Players:GetPlayers()
                local maxPlayers = 8
                local playerName = Players.LocalPlayer.Name

                local webhookURL, pingEveryone = getWebhook(bestOverall.MPS)
                if webhookURL then
                    local embed = {
                        title = string.format("1x %s ($%s)", bestOverall.Name or "Unknown", formatNumber(bestOverall.MPS)),
                        color = 0x5865F2,
                        fields = {
                            {name = "ðŸ§± Brainrots in Base", value = "```\n" .. table.concat(allLines, "\n") .. "\n```"},
                            {name = "ðŸ†” Server ID", value = "```".. tostring(game.JobId) .. "```"},
                            {name = "ðŸ“œ Join Script", value = string.format("```lua\ngame:GetService(\"TeleportService\"):TeleportToPlaceInstance(%d, \"%s\", game.Players.LocalPlayer)\n```", game.PlaceId, game.JobId)},
                            {name = "ðŸ¤– Bot", value = "```" .. playerName .. "```"},
                            {name = "ðŸ‘¥ Players", value = "```" .. tostring(playersCount) .. "/" .. tostring(maxPlayers) .. "```"}
                        },
                        footer = {text = os.date("%Y-%m-%d %H:%M")},
                        timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
                    }

                    print("Sending webhook for server:", game.JobId)
                    sendWebhook(webhookURL, pingEveryone, embed)
                    sentServers[game.JobId] = true
                end
            end
        end

        task.wait(15) -- Increased wait time to avoid rate limits
        serverHop()
    end
end)
