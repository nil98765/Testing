task.spawn(function()
    local DEBUG = true
    local WEBHOOK_COOLDOWN = 5
    local lastSent = {}
    local queue = {}
    local busy = false

    local HttpService = game:GetService("HttpService")
    local Players = game:GetService("Players")
    local Workspace = game:GetService("Workspace")
    local TeleportService = game:GetService("TeleportService")
    local Player = Players.LocalPlayer

    local WEBHOOK_1M_10M = "https://discord.com/api/webhooks/1444263728446050455/iYXA8aaJOfWhlgCQ04YwW3vzraBAwIEvDi7-EdVgU--ACEXHktcwN69XuEarlVwD6ZR-"
    local WEBHOOK_10M_100M = "https://discord.com/api/webhooks/1444263853624918046/u2aeooCDow7VJnJ7kt8oGmylzWIIIIirbnse0VKs1EU_PZPiPUvW8duKk33Qh88xAIiU"
    local WEBHOOK_100M_INF = "https://discord.com/api/webhooks/1444263961573724180/8m_9-VsRfxaRU_D7LmUqIM4iVEKP_QlGSdvW1RiC4juu6tkfipBiC3Q-QSQnm4N4XU5_"

    -- HTTP Queue
    local function getRequestFunction()
        return (syn and syn.request)
            or http_request
            or (http and http.request)
            or request
    end

    function QueueWebhook(url, payload)
        table.insert(queue, {Url = url, Payload = payload})
        ProcessQueue()
    end

    function ProcessQueue()
        if busy then return end
        busy = true
        task.spawn(function()
            while #queue > 0 do
                local item = table.remove(queue, 1)
                local url, body = item.Url, item.Payload
                local now = os.clock()

                if lastSent[url] and now - lastSent[url] < WEBHOOK_COOLDOWN then
                    task.wait(WEBHOOK_COOLDOWN - (now - lastSent[url]))
                end

                local req = getRequestFunction()
                if req then
                    pcall(function()
                        req({
                            Url = url,
                            Method = "POST",
                            Headers = {["Content-Type"] = "application/json"},
                            Body = body
                        })
                    end)
                end

                lastSent[url] = os.clock()
                task.wait(0.5)
            end
            busy = false
        end)
    end

    -- Formatting numbers
    local function formatNumber(num)
        if not num then return "0" end
        local s = tostring(math.floor(num))
        while true do
            local formatted, k = s:gsub("^(-?%d+)(%d%d%d)", "%1,%2")
            s = formatted
            if k == 0 then break end
        end
        return s
    end

    -- Robust parsing
    local function parseGeneration(text)
        if not text then return 0 end
        if text == "âˆž" then return math.huge end
        text = text:upper()
        local num = tonumber(text:gsub("[^%d%.]", ""))
        if not num then return 0 end
        if text:find("M") then num = num * 1e6 end
        if text:find("K") then num = num * 1e3 end
        return num
    end

    -- Scan for Brainrots in all plots
    local function getBrainrotsInPlot(plot)
        local list = {}

        for _, obj in ipairs(plot:GetDescendants()) do
            if obj.Name == "AnimalOverhead" then
                local displayName = obj:FindFirstChild("DisplayName") and obj.DisplayName.Text or "N/A"
                local generationText = obj:FindFirstChild("Generation") and obj.Generation.Text or "0"
                local genNumber = parseGeneration(generationText)

                if genNumber > 1e8 then
                    generationText = "âˆž"
                    genNumber = math.huge
                end

                table.insert(list, {
                    Name = displayName,
                    MPS = generationText,
                    NumMPS = genNumber
                })
            end
        end

        table.sort(list, function(a, b)
            return a.NumMPS > b.NumMPS
        end)

        return list
    end

    -- store best per plot
    local lastBest = {}

    while true do
        local plots = Workspace:FindFirstChild("Plots")

        if plots then
            for _, plot in ipairs(plots:GetChildren()) do
                
                local brainrots = getBrainrotsInPlot(plot)
                if #brainrots > 0 then
                    local best = brainrots[1]

                    if not lastBest[plot] then
                        lastBest[plot] = 0
                    end

                    -- only send if it's HIGHER than before
                    if best.NumMPS > lastBest[plot] then
                        lastBest[plot] = best.NumMPS

                        local lines = {}
                        for i, b in ipairs(brainrots) do
                            local emoji = (i == 1 and "ðŸ‘‘") or (i == 2 and "ðŸ¥ˆ") or (i == 3 and "ðŸ¥‰") or "ðŸ’Ž"
                            table.insert(lines, emoji .. " " .. b.Name .. " â€” $" .. b.MPS)
                        end

                        -- choose webhook
                        local webhookURL
                        local pingEveryone = false

                        if best.NumMPS == math.huge then
                            webhookURL = WEBHOOK_100M_INF
                            pingEveryone = true
                        elseif best.NumMPS >= 1e7 then
                            webhookURL = WEBHOOK_10M_100M
                        else
                            webhookURL = WEBHOOK_1M_10M
                        end

                        local embed = {
                            title = string.format("1x %s ($%s)", best.Name, best.MPS),
                            color = 0x5865F2,
                            fields = {
                                {name = "ðŸ§± Brainrots in Base", value = "```\n" .. table.concat(lines, "\n") .. "\n```"},
                                {name = "ðŸ†” Server ID", value = "```" .. game.JobId .. "```"},
                                {name = "ðŸ“œ Join Script",
                                    value = string.format(
                                        "```lua\ngame:GetService(\"TeleportService\"):TeleportToPlaceInstance(%d, \"%s\", game.Players.LocalPlayer)\n```",
                                        game.PlaceId, game.JobId
                                    )
                                },
                                {name = "ðŸ¤– Bot", value = "```" .. (Player and Player.Name or "Unknown") .. "```"},
                                {name = "ðŸ‘¥ Players", value = "```" .. #Players:GetPlayers() .. "/" .. Players.MaxPlayers .. "```"}
                            },
                            footer = {text = os.date("%Y-%m-%d %H:%M")},
                            timestamp = os.date("!%Y-%m-%dT%H:%M:%SZ")
                        }

                        local payload = pingEveryone
                            and HttpService:JSONEncode({content = "@everyone", embeds = {embed}})
                            or HttpService:JSONEncode({embeds = {embed}})

                        QueueWebhook(webhookURL, payload)

                        -- auto hop
                        local success, servers = pcall(function()
                            return TeleportService:GetPlayerPlaceInstances(game.PlaceId)
                        end)

                        if success and servers then
                            for _, s in ipairs(servers) do
                                if s.playing < s.maxPlayers then
                                    TeleportService:TeleportToPlaceInstance(game.PlaceId, s.id, Player)
                                    break
                                end
                            end
                        end
                    end
                end
            end
        end

        task.wait(4)
    end
end)
